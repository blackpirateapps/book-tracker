<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Latest Read Book</title>
    <!-- Uses the pre-compiled Tailwind CSS file for styling. -->
    <link href="/styles/output.css" rel="stylesheet">
    <style>
        /* Uses a stack of common, browser-safe fonts. No external requests are made. */
        :root { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            /* CSS variables for easy theme customization via URL parameters. */
            --bg-color: #ffffff;
            --text-color: #374151;
            --quote-color: #111827;
            --border-color: #e5e7eb;
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
            font-size: 14px;
        }
        
        /* Responsive improvements for cover images and highlights */
        .book-cover {
            max-width: 80px;
            max-height: 120px;
            object-fit: cover;
        }
        
        @media (max-width: 640px) {
            .book-cover {
                max-width: 60px;
                max-height: 90px;
            }
        }
        
        .highlight-text {
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.5;
        }
        
        .stats-badge {
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            background-color: rgba(59, 130, 246, 0.1);
            color: #2563eb;
            font-weight: 600;
        }
    </style>
</head>
<body class="p-4">

    <div id="widget-container" class="w-full h-full">
        <!-- A skeleton loader is shown initially to prevent content popping or layout shifts. -->
        <div id="skeleton" class="animate-pulse w-full">
            <div class="flex justify-between items-center mb-3">
                <p class="text-xs font-semibold uppercase tracking-wider text-gray-400">LATEST READ</p>
                <div class="h-4 bg-gray-200 rounded w-20"></div>
            </div>
            <div class="flex space-x-4">
                <div class="w-20 h-28 bg-gray-200 rounded-md flex-shrink-0"></div>
                <div class="flex-grow pt-1 space-y-3 w-full">
                    <div class="h-4 bg-gray-200 rounded w-5/6"></div>
                    <div class="h-3 bg-gray-200 rounded w-3/4"></div>
                    <div class="space-y-2 mt-4">
                        <div class="h-3 bg-gray-200 rounded w-full"></div>
                        <div class="h-3 bg-gray-200 rounded w-1/2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- The actual content, which is hidden by default. -->
        <div id="content" class="hidden"></div>

        <!-- An error message, also hidden by default. -->
         <div id="error" class="hidden flex items-center justify-center h-full text-center">
            <p class="text-sm text-gray-500">Could not load latest read book.</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const contentEl = document.getElementById('content');
            const skeletonEl = document.getElementById('skeleton');
            const errorEl = document.getElementById('error');
            
            // This function calculates the total height of the content and sends it to the parent page.
            const sendHeight = () => {
                const height = document.body.scrollHeight;
                // The parent window receives this message and can use it to adjust the iframe's height.
                // Using '*' is convenient for demos, but for production, you might restrict this to your site's origin for security.
                window.parent.postMessage({ frameHeight: height, frameUrl: window.location.href }, '*');
            };

            // A ResizeObserver is the most reliable way to detect content size changes.
            // It will automatically send the new height if the content reflows (e.g., on window resize).
            const resizeObserver = new ResizeObserver(() => sendHeight());
            resizeObserver.observe(document.body);

            // This section reads URL parameters to allow for easy color theme customization.
            const params = new URLSearchParams(window.location.search);
            const theme = {
                bg: params.get('bg'),
                text: params.get('text'),
                quote: params.get('quote'),
                border: params.get('border')
            };

            const root = document.documentElement;
            if (theme.bg) root.style.setProperty('--bg-color', `#${theme.bg}`);
            if (theme.text) root.style.setProperty('--text-color', `#${theme.text}`);
            if (theme.quote) root.style.setProperty('--quote-color', `#${theme.quote}`);
            if (theme.border) root.style.setProperty('--border-color', `#${theme.border}`);
            
            try {
                // Fetch both the latest read and stats data
                const [latestReadResponse, statsResponse] = await Promise.all([
                    fetch('/api/latest-read'),
                    fetch('/api/stats')
                ]);
                
                if (!latestReadResponse.ok) throw new Error('Failed to fetch latest read data');
                if (!statsResponse.ok) throw new Error('Failed to fetch stats data');
                
                const data = await latestReadResponse.json();
                const statsData = await statsResponse.json();

                // Calculate current year stats
                const currentYear = new Date().getFullYear().toString();
                const currentYearBooks = statsData.booksByYear[currentYear] || [];
                const totalBooks = currentYearBooks.length;
                const totalPages = currentYearBooks.reduce((sum, book) => sum + (book.pageCount || 0), 0);

                // Use a placeholder if no cover image URL is available.
                const coverUrl = data.coverUrl || `https://placehold.co/80x112/${theme.bg || 'e2e8f0'}/${theme.text || '475569'}?text=N/A`;

                // Build the HTML with the fetched data, including stats badge
                contentEl.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <p class="text-xs font-semibold uppercase tracking-wider text-gray-400">LATEST READ</p>
                        <span class="stats-badge">${totalBooks} books Â· ${totalPages.toLocaleString()} pages</span>
                    </div>
                    <div class="flex space-x-4">
                        <img src="${coverUrl}" alt="Cover of ${data.title}" class="book-cover rounded-md shadow-sm flex-shrink-0" style="border: 1px solid var(--border-color);">
                        <div class="flex-grow pt-1 min-w-0">
                            <p class="font-bold truncate" style="color: var(--quote-color);">${data.title}</p>
                            <p class="text-sm truncate">${data.author}</p>
                            <blockquote class="mt-2 border-l-2 pl-3" style="border-color: var(--border-color);">
                                <p class="text-sm italic highlight-text" style="color: var(--quote-color);">"${data.highlight}"</p>
                            </blockquote>
                        </div>
                    </div>
                `;
                
                // Hide the skeleton and show the content.
                skeletonEl.style.display = 'none';
                contentEl.classList.remove('hidden');

            } catch (err) {
                // If anything goes wrong, show the error message.
                console.error(err);
                skeletonEl.style.display = 'none';
                errorEl.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>